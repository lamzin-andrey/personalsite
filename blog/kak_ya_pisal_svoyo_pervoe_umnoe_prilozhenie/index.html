<!DOCTYPE html>
<html xml:lang="ru" lang="ru">
	<head>
		<meta charset="WINDOWS-1251">
		<meta name="viewport" content="	initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,target-densitydpi=device-dpi,	width=device-width,height=device-height,shrink-to-fit=no">
		<title>Сайт Андрея Ламзина</title>
		<link rel="stylesheet" type="text/css" href="/s/bootstrap4.2.1.min.css">
		<link rel="stylesheet" type="text/css" href="/s/app.css">
		<link rel="stylesheet" type="text/css" href="/j/prism/0.css">
		<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" >
	</head>
	<body>
		<div class="container u-full-width">
			<header>
				<div class="row">
					<div class="col">
						<div class="text-left u-mainhead">
							<h1>Блог Андрея</h1>
						</div>
					</div>
				</div>
			</header>
			<div>&nbsp;</div>
			<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #e3f2fd;">
			  <a class="navbar-brand" href="/">Начало</a>
			  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			  </button>

			  <div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav mr-auto">
				  <li class="nav-item">
					<a class="nav-link" href="/portfolio">Портфолио</a>
				  </li>
				  <li class="nav-item active">
					<a class="nav-link" href="javascript:;">Блог</a>
				  </li>
				  <li class="nav-item">
					<a class="nav-link" href="/clients">Клиентам</a>
				  </li>
				</ul>
			  </div>
			</nav>
			<div>&nbsp;</div>
			<div class="row">
				<div class="col-12 col-lg-8">
					<article>
						<h1>Как я писал своё первое &laquo;умное&raquo; приложение</h1>
						<p>Это интересно, но впервые я задумался о том, что было бы неплохо, чтобы мой смартфон сам убавлял яркость на ночь пришла мне в голову примерно через 7 лет использования смартфонов.
Скорее всего, поводом послужила информация о том, что продвинутые модели оснащены сенсорами и устанавливают яркость в зависимости от освещения. Мне как раз хотелось написать что-то небольшое, но законченное 
(долгосрочные проекты, которым конца-края не видно нередко вызывают такое желание) и у меня было время на осуществление этого желания.</p>
						<p>Я не сомневался, что подобных приложений в Google Play хоть пруд пруди, но мне хотелось сделать самому.</p>
						<p>Поначалу я хотел написать обычный планировщик, в который можно было бы вносить время, когда убавить яркость и насколько, а когда прибавить.
Чуть позже пришла идея, что неплохо бы заставить аппарат запоминать изменения яркости. Я буду просто изменять системную настройку яркости, как делал всё это время, а смартфон будет собирать статистику.
Мне придется реже делать это вручную, а после года использования - ещё реже, так как приложение сможет использовать статистику за год.</p>
						<p>Идея показалась похожей на хорошую и заслуживающей немедленной реализации. Но как это сделать?</p>
						<p>Для начала был придуман сервис в фоне. Прежде всего он делает простую вещь: ежеминутно записывает текущее значение яркости в память. </p>
						<p>Но, перед записью сервис проверяет, не изменилось ли предыдущее значение по сравнению с текущим. Если изменилось, факт изменения фиксируется в памяти устройства.</p>
						<p>Если же значение не изменилось, сервис запрашивает сохраненное ранее в это время суток значение яркости и если оно найдено, устанавливает. Но только в том случае, если пользователь только что не изменил яркость по своему усмотрению.</p>
						<p>План похож на хороший, осталось подумать, каким именно образом фиксировать факт изменения записи и каким образом определить, что надо изменять яркость.</p>
						<p>Сначала рассмотрим тривиальный случай, как будто бы у нас всегда день и ночь неизменяемой продолжительности. Другими словами, допустим, что пользователь всегда убавляет яркость в одно и то же время и всегда прибавляет яркость в одно и то же время. Так как сервис совершает свой анализ раз в минуту (чаще, пожалуй излишне, да и батарея не резиновая), время буду сохранять как количество минут, прошедших с начала года и как количество минут, прошедших с начала текущих суток.</p>
						<p>При фиксации изменения яркости достаточно записать в файл яркость в текущее время T и яркость минуту назад во время T0.</p>
						<p>T будет соответствовать текущая яркость </p>
						<p>T0 будет соответствовать яркость минуту назад</p>
						<p>Тогда будет достаточно для умной установки яркости взять текущее время C и сравнить разности C - T и C - T0.</p>
						<p>Если разность отрицательна, её не рассматриваем (потому что момент в текущие сутки ещё не наступил).</p>
						<p>Из положительных разностей выбираем меньшую и устанавливаем соответствующее ей значение яркости.</p>
						<p>Теперь реальные случаи, они сложнее.</p>
						<p>Так как мой смартфон может лежать несколько дней без включения, найти файл (или запись в базе данных, сейчас это не суть важно) с записями вчерашних изменений яркости нельзя.
Тем более невероятно найти файл годичной давности. Хочется найти файл примерно годичной давности, но маскимально близкий к текущему календарному дню.
Причём надо предусмотреть, что его вообще может не быть. Например, интересует 02 05 2018, а из близких есть только 23 04 2018 и 15 06 2018
(Как их найти - это отдельный вопрос). Но есть ещё файл за 30 04 2019 и очевидно, что при отсутствии 02 05 2018 лучше бы взять за основу именно его - файл за 30 04 2019.</p>
						<p>То есть, надо найти файл с изменениями независимо от года, такой, что дата создания файла отстоит от текущей минимально.
 Этого можно добиться, если именовать файлы с изменениями количеством минут, прошедших с начала года до начала тех суток, в которые был создан файл.</p>
						<p>На языке SQL это будет выглядеть примерно вот так:</p>
						<div class="border p-2">
							<code class="language-sql ">SELECT * FROM table WHERE ABS(spectime - N) = (SELECT MIN( ABS(spectime - N) ) FROM table);</code>
						</div>
						<p>где N  - время в минутах, прошедшее с начала года. Оно вычисляется для суток года без учета часов, прощедших с начала суток.</p>
						<p>spectime - поле типа integer в котором и хранится N при каждом сохранении факта того, что яркость изменилась.</p>
						<p>Итак, запросом получаем имя файла, из файла получаем актуальное значение яркости по описаному выше "тривиальному" алгоритму</p>
						<p>Но, жизнь ещё сложнее. Например: </p>
						<ul>
							<li>01 04 2019 в 18 00 я убавил яркость, потому что уже стемнело и глазам стало слишком ярко.</li>
							<li>Потом я уехал на месяц, а смартфон выключил и забыл. (Если смартфонов несколько, вполне реальная ситуация).</li>
							<li>01 05 2019, в 19 00 я убавил яркость, потому что уже стемнело и глазам стало слишком ярко.</li>
							<li>02 05 2019 я проснулся ночью в 2 часа, включил свет и прибавил яркость телефона, потому что было слишком слабо.</li>
							<li>02 05 2019 в 19 00 алгоритм пойдёт искать ближайший файл, найдет запись за 02 05 (она создалась в 2 часа ночи).</li>
							<li>И не убавит яркость дисплея, так как ближайшая к нему точка в минутах с начала суток - 02 00, а в это время яркость была прибавлена.</li>
						</ul>
						<p>Что делать?</p>
						<p>Можно например выбрать три записи вместо одной. Или любое другое нечетное количество.</p>
						<p>Тогда, по анализу файла за 01 05 будет "голос" - надо убавить</p>
						<p>По анализу файла за 01 04 будет "голос" - надо убавить</p>
						<p>Два против одного - убавляем. Всё классно.</p>
						<p>Итак, как в итоге работает.</p>
						<ul>
						<li>Ежеминутно сохраняется изменение яркости НЕ нашим приложением (пользователем или другими приложениями).</li>
						<li>Журнал изменений за каждые сутки хранится в отдельном файле или в отдельной записи таблицы БД</li>
						<li>Каждую минуту берутся три журнала ближайшие к текущей дате.</li>
						<li>Из каждого журнала выбирается момент смены яркости, ближайший к текущему моменту. (в этом пункте надо оперировать минутами в пределах суток)</li>
						<li>После анализа каждого журнала получаем "голос" - менять ли яркость, в какую сторону (увеличивать или уменьшать) и какое значение в итоге установить.</li>
						<li>После подсчёта голосов принимается решение - менять яркость или нет и какое значение установить.</li>
						<li>Если значения яркости для каждого голоса различны, выбирается значение из того журнала, который ближе к текущему моменту.
Время считается в минутах с начала года, таким образом после года эксплуатации учитываются и "будущие" значения яркости.</li>
						</ul>
						<p>Это казалось хорошим решением, но уже после реализации приложения я обнаружил, что если яркость изменялась например в меньшую сторону двое суток подряд в определенное время, на третьи она настойчиво изменялась туда же, даже если мне это было не нужно.</p>
						<p>То есть, предусмотренный в самом начале пункт "менять яркость только в том случае, если пользователь только что не изменил яркость по своему усмотрению" не был реализован. Поэтому было добавлено следующее правило:</p>
						<p> <strong>"Голоса" "за изменение" и "против изменений" не учитываются в одном только случае - если есть фиксированное изменеие за текущие сутки и этот "голос" - наиболее близкий к текущему времени.</strong></p>
						<p>Для определения, что изменение именно за текущие сутки пришлось помимо количества минут, прошедших с начала года сохранять ещё и год.</p>
						<p>В итоге получилось именно то, что я хотел, скачать приложение можно с <a href="https://play.google.com/store/apps/details?id=land.learn.hw19" target="_blank">Google Play</a>.</p>
					</article>
				</div>
				<div class="col-12 col-lg-4  u-right-side">
					<ul class="list-group text-center">
						<li class="list-group-item">
							<div><img src="/i/fx.jpg" alt="Fastxampp"></div>
							<div> <!-- style="border-top-width: 0px;" -->
								<a href="//fastxampp.org" target="_blank">Утилита для удобного добавления сайтов на localhost</a>
							</div>
						</li> 
						<li class="list-group-item">
							<div><img src="/i/L.jpg"  alt="cordova online"></div>
							<div><a target="_blank" href="http://fastxampp.org/compile_android_online_apache_cordova/">Компиляция html5 приложений cordova для android онлайн</a><br>
								<p>
									<small>
									</small>
								</p>
							</div>
						</li>
						<li class="list-group-item">
							<div>
								<img src="/i/php2js.jpg" title="" alt="">
							</div>
							<div>
								<a href="http://php2js.ru/" target="_blank">Транслятор php кода в код javascript</a><br>
							</div>
						</li>
						<li class="list-group-item">
							<div><img src="/i/rc.jpg" alt="RedCafe"></div>
							<div><a href="http://redcafe.ru/">Программа для создания выкроек стильной одежды</a></div>
							<p>
								<small>Мой вклад - оффлайн-версия программы для экспорта выкроек в pdf и dxf</small></div>
							</p>
						</li>
					</ul>
				</div>
			</div>
		</div>
		
			<div class="footer bg-dark text-light">
				
					<div class="container">
						<div class="row">
							<div class="col">
								&copy; Андрей Ламзин
							</div>
						</div>
					</div>
				
			</div>
		
        <script src="/j/jquery-3.3.1.slim.min.js"></script>
        <script src="/j/bootstrap4.2.1.min.js"></script>
        <script src="/j/popper1.14.6.min.js"></script>
        <script src="/j/prism/0.js"></script>
        <script src="/j/app.js"></script>
        <link rel="stylesheet" type="text/css" href="/s/bootstrap4_sticky_footer.css">
	</body>
</html>
