var abcIsInitalize=0;var Map=[];function initAbc(r,m){var b;b="012 3456789\n\r?!,.абвгдеёжзийклмнопрстуфхцчшщъыьэюяЙЦУКЕНГФЫВАПРОЛДЖЭЯЧСМИТЬБЮШЩЗХЪasdfghjklzxcvbnm-+qwertyuiopZXCVBNMASDFGHJKLQWERTYUIOP():/`=*[];'\t~@#$%^&_{}|\"<>№";if(abcIsInitalize){m.abc=b;m.m=Map;return}var k,o,q=[],i,j,p;if(!validPassword(r,b)){Error("Invalid password")}for(k=0;k<b.length;k++){q[k]=k}o=0;for(k=0;k<b.length;k++){if(o>r.length-1){o=0}ch=r.charAt(o);di=b.indexOf(ch);dI=q[di];I=q[k];i=I+dI;i=i>b.length-1?i-b.length:i;p=arrIndexOf(q,i);q[k]=i;q[p]=I;o++}m.abc=b;Map=q;m.m=q;abcIsInitalize=1}function arrIndexOf(e,d){for(var f=0;f<e.length;f++){if(e[f]==d){return f}}return -1}function validPassword(f,d){for(var e=0;e<sz(f);e++){if(!~d.indexOf(f.charAt(e))){return false}}return true}function decrypt(z,x){z=z.split(";");var m,r,u=0,i,v,y="",w,p,j,b={},s;initAbc(x,b);for(r=0;r<z.length;r++){u=u<x.length?u:0;v=String(charCode(x,u,b));v=v.replace("n","");i=z[r];if(i.charAt(0)=="n"){s=1;i=i.replace("n","")}else{s=0}i=+i;v=+v;w=i-v;p=getLimit(i,b,s);j=b.b;if(w<j){w=p-Math.abs(w-j);i=w}else{i=w}i=fromCharCode(i,s,b);y+=String(i);u++}return y}function crypt(z,x){var m,r,u=0,i,v,y=[],w,b={},p,j,s;initAbc(x,b);for(r=0;r<z.length;r++){i=String(charCode(z,r,b));if(i.charAt(0)=="n"){s=1;i=i.replace("n","")}else{s=0}i=+i;u=u<x.length?u:0;v=String(charCode(x,u,b));v=v.replace("n","");v=+v;w=i+v;getLimit(w,b,s);p=b.L;j=b.b;if(w>p){i=j+w-p}else{i=w}if(s){i="n"+i}y.push(i);u++}return y.join(";")}function fromCharCode(g,f,c){if(f){return String.fromCharCode(g)}var h=arrIndexOf(c.m,g-1);return c.abc.charAt(h)}function charCode(i,k,m){var l,n,b,j=m.abc;l=j.indexOf(i.charAt(k));if(~l){l=m.m[l];return(l+1)}return"n"+i.charCodeAt(k)}function getLimit(e,f,d){if(d){return getLimitN(e,f)}f.L=f.abc.length;f.b=1;return f.L}function getLimitN(i,g){var h=[9,125,1025,1103],j,b;if(i>h[0]&&i<h[1]){j=h[1];b=h[0]}else{if(i>=h[2]&&i<=h[3]){j=h[3];b=h[2]}else{j=1000000;b=0}}g.L=j;g.b=b;return j}window.onload=init;function init(){window.W=window;window.D=document;W.root="/c";W.app={L:"лопата"};if(W.uid){hideScreens();show(hRepeatPwdScreen)}repeatPwdBtn.onclick=onRP;mainForm.onsubmit=onMainSubmit;nextPostBtnBtm.onclick=nextPostBtn.onclick=onNextPost;newPostBtn.onclick=onNewPost;editPostBtnBtm.onclick=editPostBtn.onclick=onEditPost;registerNowBtn.onclick=onRegisterNowClick;sendRegisterDataBtn.onclick=onSendRegisterDataClick;signInBtn.onclick=onSignInClick;textCommentBtn.onclick=onSendCommentClick;history.pushState(null,null,"/c/");W.onpopstate=onBackButton}function onNewPost(){iCurrentPostId.value=0;hideScreens();iTitle.value="";iBody.value="";show(hEditPostScreen)}function onBackButton(b){b.preventDefault;hideScreens();show(hNovelScreen);success("Ваш комментарий появитсья после проверки модератором");W.scrollTo(0,0)}function onSendCommentClick(){hideScreens();show(hNovelScreen);setTimeout(function(){success("Ваш комментарий появится после проверки модератором");W.scrollTo(0,0)},3*1000);return false}function onSignInClick(){var b={iLlogin:1,iLpwd:1};_map(b,1);W.app.pwd=b.iLpwd;_post(b,onSuccessLogin,"/signin.php");return false}function onSuccessLogin(b){if(!b.error){W.password=W.app.pwd;if(b.id>0){postDataDoneHandler(b)}else{hideScreens();show(hEditPostScreen);success(b.message)}}else{W.scrollTo(0,0);error(b.error)}}function onSendRegisterDataClick(){var b={iLogin:1,iPwd:1,iPwdConfirm:1,iAgree:1};_map(b,1);app.pwd=b.iPwd;_post(b,onSendRegisterData,"/signup.php");return false}function onSendRegisterData(b){if(!b.error){success(b.message);setTimeout(function(){hideScreens();iCurrentPostId.value=0;W.password=app.pwd;success("Создайте свою первую запись");show(hEditPostScreen)},5*1000)}else{error(b.error)}}function onRegisterNowClick(){hideScreens();show(hSignUpScreen);W.scrollTo(0,0);return false}function onEditPost(){hideScreens();show(hEditPostScreen)}function onNextPost(){var b=iCurrentPostId.value;b=b?b:0;_get(postDataDoneHandler,"/nextpost.php?id="+b)}function onMainSubmit(){var c={iBody:1,iTitle:1,iCurrentPostId:1};_map(c,1);try{c.iBody=crypt(W.app.L+c.iBody,W.password)}catch(d){if(d.message=="Invalid password"){error("Пароль содержит недопустимые символы");throw d}else{throw d}}try{c.iTitle=crypt(c.iTitle,W.password)}catch(d){if(d.message=="Invalid password"){error("Пароль содержит недопустимые символы");throw d}else{throw d}}_post(c,onSaveEditFormDataUserAction,"/post.php");return false}function onSaveEditFormDataUserAction(b){postDataDoneHandler(b)}function onRP(){W.password=iRepeatPwd.value;_get(onGetLastPost,"/lastpost.php");return false}function onGetLastPost(b){postDataDoneHandler(b)}function postDataDoneHandler(c){if(!c.error){var d=setCurrentPostData(c.id,c.text,c.title);if(d){hideScreens();show(hViewPostScreen);if(c.message){success(c.message)}}else{Map=[];abcIsInitalize=0;error("Неверный пароль!")}}else{if(c.state&&c.state=="showform"){hideScreens();show(hEditPostScreen)}else{error(c.error)}}}function error(b){hide(hMessage);if(b.length>0){hErrorText.innerText=b;show(hError)}else{hide(hError)}}function success(b){hide(hError);if(b.length>0){hMessageText.innerText=b;show(hMessage)}else{hide(hMessage)}}function setCurrentPostData(h,g,i){var e="";try{e=decrypt(g,W.password)}catch(j){if(j.message=="Invalid password"){error("Пароль содержит недопустимые символы");throw"e"}else{throw j}}if(e.indexOf(W.app.L)===0){iBody.value=D.getElementById("hPostTextView").innerHTML=e.replace(W.app.L,"");try{iTitle.value=D.getElementById("hPostTitleView").innerHTML=decrypt(i,W.password)}catch(j){if(j.message=="Invalid password"){error("Пароль содержит недопустимые символы");throw j}}iCurrentPostId.value=h;D.getElementById("hPostTextView").innerHTML="<p>"+D.getElementById("hPostTextView").innerHTML.replace(/\n/mig,"</p><p>")+"</p>";D.getElementById("hPostTitleView").innerHTML="<p>"+D.getElementById("hPostTitleView").innerHTML.replace(/\n/mig,"</p><p>")+"</p>";return true}return false}function hideScreens(){var e=D.getElementsByClassName("screenWrapper"),d,f;for(d=0;d<sz(e);d++){f=$$(e[d],"div")[0];if(f.tagName=="DIV"){hide(f)}}}function _map(k,l){var i,j,g;for(g in k){i=$(g);j=i;if(j){if(j.tagName=="INPUT"||j.tagName=="TEXTAREA"){if(!l){j.value=k[g]}else{if(j.type=="checkbox"){k[g]=j.checked}else{k[g]=j.value}}}else{if(!l){if(j.type=="checkbox"){var h=k[g]=="false"?false:k[g];h=h?true:false;j.checked=h}else{j.innerText=k[g]}}else{k[g]=j.innerText}}}}}function _get(d,e,f){_restreq("get",{},d,e,f)}function _delete(d,e,f){_restreq("post",{},d,e,f)}function _post(l,k,i,j){var m=document.getElementsByTagName("meta"),n,h;for(n=0;n<m.length;n++){if(attr(m[n],"name")=="app"){h=attr(m[n],"content");break}}if(h){l._token=h;_restreq("post",l,k,i,j)}}function _patch(e,h,f,g){_restreq("patch",e,h,f,g)}function _put(e,h,f,g){_restreq("put",e,h,f,g)}function _restreq(h,f,j,g,i){if(!g){g=window.location.href}else{g=W.root+g}if(!i){i=defaultFail}switch(h){case"put":case"patch":case"delete":break}pureAjax(g,f,j,i,h)}function pureAjax(p,o,l,q,r){var i=new XMLHttpRequest();var m=[];for(var n in o){m.push(n+"="+encodeURIComponent(o[n]))}var k=m.join("&");i.open(r,p);i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");i.onreadystatechange=function(){if(i.readyState==4){var b={};if(i.status==200){try{var c=JSON.parse(String(i.responseText));l(c,i);return}catch(a){console.log(a);b.state=1;b.info="Fail parse JSON"}}else{b.state=1}if(b.state){q(i.status,i.responseText,b.info,i)}}};i.send(k)}function defaultFail(b){W.requestSended=0;error("Не удалось обработать запрос, попробуйте снова")}function storage(e,h){var f=window.localStorage;if(f){if(h===null){f.removeItem(e)}if(!(h instanceof String)){h=JSON.stringify(h)}if(!h){h=f.getItem(e);if(h){try{h=JSON.parse(h)}catch(g){}}}else{f.setItem(e,h)}}return h};