<!DOCTYPE html>
<html xml:lang="ru" lang="ru">
	<head>
		<meta charset="WINDOWS-1251">
		<meta name="viewport" content="	initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,target-densitydpi=device-dpi,	width=device-width,height=device-height,shrink-to-fit=no"><meta property="og:image" content="/i/64.jpg">
		<meta name="apptoken" content="1cdslkjhs4dfjkhs8fdjkhsg">
		<title>Компонент Vue 2 bootstrap 4 редактируемый древовидный список TreeView с немедленной отправкой данных на сервер -|- Сайт Андрея</title>
		<link rel="stylesheet" type="text/css" href="/s/bootstrap4.2.1.min.css">
		<link rel="stylesheet" href="/s/fontawesome5/all.css" >
		<link rel="stylesheet" type="text/css" href="/s/app.css">
		<link rel="stylesheet" type="text/css" href="/j/prism/0.css">
		<link href="/favicon.ico" rel="shortcut icon" type="image/x-icon" >
		<script>window.applang='ru';</script>
	</head>
	<body>
		<div class="container u-full-width">
			<header>
				<div class="row">
					<div class="col">
						<div class="text-left u-mainhead">
							<h1>Блог Андрея</h1>
						</div>
					</div>
				</div>
			</header>
			<div>&nbsp;</div>
			<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #e3f2fd;">
			  <a class="navbar-brand" href="/">Начало</a>
			  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			  </button>

			  <div class="collapse navbar-collapse" id="navbarSupportedContent">
				<ul class="navbar-nav mr-auto">
				  <li class="nav-item active">
					<a class="nav-link" href="javascript:;">Портфолио</a>
				  </li>
				  <li class="nav-item">
					<a class="nav-link" href="javascript:;">Блог</a>
				  </li>
				  <li class="nav-item">
					<a class="nav-link" href="/clients/">Клиентам</a>
				  </li>
				</ul>
			  </div>
			</nav>
			<div>&nbsp;</div>
			<div class="row">
				<div class="col-12 col-lg-8">
					<article>
						<h1>Vue 2 bootstrap 4 редактируемый древовидный список TreeView - online demo</h1>
						<time datetime="2019-08-08" class="d-block text-right text-muted small">08.08.2019</time>
						
						<div  id="wrapper">
							<accordionselecttree
								id="categoriesTree"
								default-icon-class="fas fa-box"
								:accordisopen="true"
								:label="$t('app.Category')"
								v-model="selectedCategory"
								:treedata="categoriesTree"
								url-create-new-item="https://andryuxa.ru/p/treedemo/dcatsave.jn/"
								url-update-item="https://andryuxa.ru/p/treedemo/dcatsave.jn/"
								url-remove-item="https://andryuxa.ru/p/treedemo/dcatdelte.jn/"
								:show-icons="true"
								ref="treeview"
							></accordionselecttree>
						</div>
					-------
<p>Компонент vue 2 сочетающий аккордион и древовидную структуру для выбора элемента древовидной структуры.</p>

<p>Базируется на компоненте https://github.com/lamzin-andrey/landlib/tree/master/vue/2/bootstrap/4/bootstrap-vue-treeview, который в свою очередь форк проекта https://github.com/kamil-lip/bootstrap-vue-treeview</p>

<p>Добавление, редактирование и удаление элементов дерева немедленно отправляется на url сервера, которые вы можете указать в атрибутах  `urlCreateNewItem`, `urlUpdateItem`, `urlRemoveItem`.</p>

<p>Связанная с компонентом модель содержит id выбранного элемента.</p>

<h3>Зависимости</h3>

jquery
vue 2
bootstrap4
i18n
landlib https://github.com/lamzin-andrey/landlib.git


<h3>Установка</h3>

`git clone https://github.com/lamzin-andrey/landlib.git`

<h2>Использование</h2>

<h3>Данные на сервере</h3>

Пусть есть таблица базы данных `categories` с полями 

| id | parent_id | name |
| --- | --- | --- |
| 1 | 0 | Все категории |
| 2 | 1 | Бытовая техника |
| 3 | 1 | Электроника |
| 4 | 3 | Мобильные телефоны |
| 5 | 3 | Ноутбуки |
| 6 | 3 | Телевизоры |

Вы хотите отобразить это в виде редактируемного древовидного списка.

Бэкенд должен обеспечить вам данные следующего вида:

```json
[
	{
		"id" : 1,
		"parent_id" : 0,
		"name" : "Все категории",
	},
	{
		"id" : 2,
		"parent_id" : 1,
		"name" : "Бытовая техника",
	},
	{
		"id" : 3,
		"parent_id" : 1,
		"name" : "Электроника",
	},
	{
		"id" : 4,
		"parent_id" : 3,
		"name" : "Мобильные телефоны",
	},
	{
		"id" : 5,
		"parent_id" : 3,
		"name" : "Ноутбуки",
	},
	{
		"id" : 6,
		"parent_id" : 3,
		"name" : "Телевизоры",
	}
]
```

<h3> Код базового приложения<h3>

<h4>package.json</h4>

```json
{
	"private": true,
	"scripts": {
		"dev": "npm run development",
		"development": "cross-env NODE_ENV=development node_modules/webpack/bin/webpack.js --progress --hide-modules --config=node_modules/laravel-mix/setup/webpack.config.js",
		"watch": "npm run development -- --watch",
		"watch-poll": "npm run watch -- --watch-poll",
		"prod": "npm run production",
		"production": "cross-env NODE_ENV=production node_modules/webpack/bin/webpack.js --no-progress --hide-modules --config=node_modules/laravel-mix/setup/webpack.config.js",
		"test": "echo 'none'"
	},
	"devDependencies": {
		"jquery": "^3.4.1",
		"cross-env": "^5.2.0",
		"laravel-mix": "^2.1.11",
		"vue": "^2.5.17",
		"vue-i18n": "^7.0.0"
	},
	"dependencies": {
		"vue-context-menu": "^2.0.6"
	}
}

```

<h4>Vue код</h4>

Код vue компонента для вставки в HTML шаблон

```html
<accordionselecttree
	id="categoriesTree"
	v-model="selectedCategory"
	default-icon-class="fas fa-box"
	:show-icons="true"
	:label="$t('app.Category')"
	:treedata="categoriesTree"
	url-create-new-item="https://andryuxa.ru/p/treedemo/dcatsave.jn/"
	url-update-item="https://andryuxa.ru/p/treedemo/dcatsave.jn/"
	url-remove-item="https://andryuxa.ru/p/treedemo/dcatdelte.jn/"
	ref="treeview"
></accordionselecttree>
<textarea hidden style="display:none" id="categorydata">[
	{
		"id" : 1,
		"parent_id" : 0,
		"name" : "All categories"
	},
	{
		"id" : 2,
		"parent_id" : 1,
		"name" : "Appliances"
	},
	{
		"id" : 3,
		"parent_id" : 1,
		"name" : "Electronics"
	},
	{
		"id" : 4,
		"parent_id" : 3,
		"name" : "Cell phones"
	},
	{
		"id" : 5,
		"parent_id" : 3,
		"name" : "Notebooks"
	},
	{
		"id" : 6,
		"parent_id" : 3,
		"name" : "Tv Sets"
	}
]</textarea>
```

<h4>app.js</h4>

```javascript
//Vue и jquery
window.jQuery = window.jquery = window.$ = require('jquery');
window.Vue = require('vue');

//Локализация
import VueI18n  from 'vue-i18n';
import locales  from './vue-i18n-locales';

const i18n = new VueI18n({
    locale: 'en', // set locale
    messages:locales, // set locale messages
});
//end Локализация


//Проследите, чтобы пути к файлам библиотек были указаны верно

//REST library
require('../../../j/sources/landlib/net/rest.js');

//Yfi rjvgjytyn
Vue.component('accordionselecttree', require('../../../j/sources/landlib/vue/2/bootstrap/4/accordionselecttree/accordionselecttree.vue'));

window.app = new Vue({
	i18n : i18n,
	el: '#wrapper',
	
	data: {
		/** @property {Number} selectedCategory выбранное свойство */
		selectedCategory : 3,

		/** @property {Array} categoriesTree данные дерева */
		categoriesTree : [{id:1, name:"Loading..."}],

	},
	methods : {
		//csrf токен для ajax запросов 
		_getToken() {
			let ls = document.getElementsByTagName('meta'), i;
			for (i = 0; i < ls.length; i++) {
				if (ls[i].getAttribute('name') == 'apptoken') {
					return ls[i].getAttribute('content');
				}
			}
			return '';
		}
	},
	/**
	 * @description Событие, наступающее после связывания el с этой логикой
	*/
	mounted() {
		//csrf токен для ajax запросов 
		Rest._token = this._getToken();
		//На каком языке отвечать
		Rest._lang = 'en';

		//Эти данные могли бы быть полученны с сервера, в этом примере они в формате JSON хранятся в textarea
		let data = $('#categorydata').val();
		//this.selectedCategory = this.value;
		try {
			data = JSON.parse(data);
			//Если сервер вернул "плоский" список, мы можем построить из него дерево сами
			data = TreeAlgorithms.buildTreeFromFlatList(data, true);
			this.categoriesTree = data;
			//or this.categoriesTree[0] = data[0]; если vue warning
			setTimeout(() =>{
				this.selectedCategory = 3;	//Напрмер мы на странице товара, а сервер вернул нам помимо данных дерева категорий категорию товара
				this.$refs.treeview.selectNodeById(this.selectedCategory);
			}, 500);
		} catch(e){
			//console.log(e);
		}
	},
});
```

<h4> Атрибуты компонента</h4>

<h5>id</h5>

Каждый компонентом accordionselecttree создает скрытый инпут с id и name равным переданному id. Это удобно, если компонент содержится внутри формы, которая будет отправляться без участия javascript.

<h5>v-model</h5>

Стандартная директива vue. Компонент реактивен, то есть например связав его модель с текстовым инпутом вы можете вводить эти данные и наблюдать динамическое выделение элемента дерева, id которого ввели.

##### default-icon-class (defaultIconClass)

Вы можете указать иконку fontawesome, которая будет отображаться рядом с элементом списка.

##### show-icons (showIcons)

Показывать ли иконку

##### label

Текст, который отобразится в заголовке аккордиона.

##### treedata

Передайте в этот атрибут имя поля vue приложения (или vue компонента), которое будет хранить данные дерева.

##### url-create-new-item (urlCreateNewItem)

Укажите url на который отправятся данные о родительском элементе в который добавляется новый узел.
Узел будет добавлен после того, как сервер вернет идентификатор и имя нового элемента.

##### url-update-item (urlUpdateItem)
								
Укажите url на который отправятся данные о новом имени переименованного элемента.
Запрос будет выполнен после того, как элемент дерева переименован.

##### url-remove-item (urlRemoveItem)

Укажите url на который отправятся данные об удаляемом узле и его потомках.
Запрос будет выполнен после того как узел скрыт из дерева. Если сервер не смог обработать запрос, узел и его потомки будут восстановлены в дереве и показано сообщение об ошибке.

##### node-parent-key-prop (nodeParentKeyProp)

Если оказалось, что в данных, которые вернул сервер поле хранящее идентификатор родительского элмента называется не `parent_id`, а иначе, например `parent_node_id`, вы можете указать его имя в этом атрибуте.

##### node-parent-key-prop (nodeParentKeyProp)

Если оказалось, что в данных, которые вернул сервер поле хранящее идентификатор родительского элмента называется не `parent_id`, а иначе, например `parent_node_id`, вы можете указать его имя в этом атрибуте.
    Аналогичное свойство объекта TreeAlgorithms называется `parentIdFieldName`.

##### node-key-prop (nodeKeyProp)
			
Аналогично nodeParentKeyProp, но для поля, хранящего идентификатор элемента.
	Аналогичное свойство объекта TreeAlgorithms называется `idFieldName`.
			
##### node-сhildren-prop (nodeChildrenProp)

Аналогично nodeParentKeyProp, но для поля, хранящего потомков элемента. В нашем примере из этой документации мы исходим из того, что сервер вернул плоский список и строим из него дерево.
	Аналогичное свойство объекта TreeAlgorithms называется `childsFieldName`.

```javascript
data = TreeAlgorithms.buildTreeFromFlatList(data, true);
```

Выше фрагмент кода, который строит дерефо из плоского списка. Результатом его работы будет (для нашего примера)

```json
[
	{
		"id" : 1,
		"parent_id" : 0,
		"name" : "All categories",
		"children" : [
			{
				"id" : 2,
				"parent_id" : 1,
				"name" : "Appliances"
			},
			{
				"id" : 3,
				"parent_id" : 1,
				"name" : "Electronics",
				"children" : [
					{
						"id" : 4,
						"parent_id" : 3,
						"name" : "Cell phones"
					},
					{
						"id" : 5,
						"parent_id" : 3,
						"name" : "Notebooks"
					},
					{
						"id" : 6,
						"parent_id" : 3,
						"name" : "Tv Sets"
					}
				]
			},
		] 
	}
]
```

Эти данные могли бы сразу прийти с сервера. Но поле `children` в этом случае могло бы называтсья иначе, например `child_items`. В этом случае мы можем передать `nodeChildrenProp="child_items"` для обеспечения работы компонента.
    Аналогичное свойство объекта TreeAlgorithms называется `childsFieldName`.

##### node-label-prop (nodeLabelProp)

Аналогично nodeParentKeyProp, но для поля, хранящего имя элемента.
	Объект TreeAlgorithms не имеет аналогичного свойства, так как оно ему не нужно.
	
##### nodes-draggable (nodesDraggable)

Boolean. Позволяет перемещать узлы дерева. В настоящее время не поддерживается серверной стороной.

##### context-menu (contextMenu)

Boolean. Позволяет ивключить ли отключить контекстное меню.

##### rename-node-on-dbl-click (renameNodeOnDblClick)

Boolean. Позволяет ивключить ли отключить переименование свойства при двойном клике на нём.

##### default-icon-class (defaultIconClass)

String. Можно указать имя иконки fontawesome, например `fas fa-book`

##### accordisopen

Boolean. Можно указать должен дли аккордион быть открытым или закрытым по умолчанию

### Формат данных для сервера.

Компонент автоматически отправляет данные на сервер после добавления, переименования и удаления элемента.

Данные отправляются в формате `form-data`.

Примеры запросов и ответов:

#### Добавление узла

Запрос:

| Имя переменной | Пример значения | Обязательный |
| --- | --- | --- |
| parent_id | 3 | Yes |
| _token | 1cdslkjhs4dfjkhs8fdjkhsg | Yes |
| lang | en | Нет |

Response:

```json
{
	"status":"ok",
	"id":2412,
	"name":"New Item",
	"parent_id":2410
}
```

#### Переименование узла

Запрос:

| Имя переменной | Пример значения | Обязательный |
| --- | --- | --- |
| id | 2412 | Да |
| _token | 1cdslkjhs4dfjkhs8fdjkhsg | Да |
| parent_id | 3 | Нет |
| lang | en | Нет |

Ответ:

```json
{
	"status":"ok",
	"id":2412,
	"name":"Овощи и гирлянды",
	"parent_id":2410
}
```

#### Удаление узла

Запрос:


| Имя переменной | Пример значения | Обязательный |
| --- | --- | --- |
| idList[] | 2412 | Да |
| idList[] | 2413 | Да |
| idList[] | 2526 | Да |
| _token | 1cdslkjhs4dfjkhs8fdjkhsg | Да |
| lang | en | Нет |

Ответ:

```json
{
	"status":"ok",
	"msg":"Record was removed",
	"ids":[2411,2413,2415,2414]
}
```

**Передавать в ответе сервера список идентификаторов необходимо для корректной раьботы компонента**


## Объект TreeAlgorithms

Это специальный объект, содержащий удобные методы для работы с древовидными структурами данных. Он не зависит от vue или других библиотек и фреймвёрков. Описание его молжно найти тут https://github.com/lamzin-andrey/landlib#treealgorithms
https://github.com/lamzin-andrey/landlib#treealgorithms-1 (ru)



					-------
					
					
					</article>
				</div>
				<div class="col-12 col-lg-4  u-right-side">
					<ul class="list-group text-center">
						<li class="list-group-item">
							<div><img src="/i/fx.jpg" alt="Fastxampp"></div>
							<div> <!-- style="border-top-width: 0px;" -->
								<a href="//fastxampp.org" target="_blank">Утилита для удобного добавления сайтов на localhost</a>
							</div>
						</li> 
						<li class="list-group-item">
							<div><img src="/i/L.jpg"  alt="cordova online"></div>
							<div><a target="_blank" href="http://fastxampp.org/compile_android_online_apache_cordova/">Компиляция html5 приложений cordova для android онлайн</a><br>
								<p>
									<small>
									</small>
								</p>
							</div>
						</li>
						<li class="list-group-item">
							<div>
								<img src="/i/php2js.jpg" title="" alt="">
							</div>
							<div>
								<a href="http://php2js.ru/" target="_blank">Транслятор php кода в код javascript</a><br>
							</div>
						</li>
						<li class="list-group-item">
							<div><img src="/i/rc.jpg" alt="RedCafe"></div>
							<div><a href="http://redcafe.ru/">Программа для создания выкроек стильной одежды</a></div>
							<p>
								<small>Мой вклад - оффлайн-версия программы для экспорта выкроек в pdf и dxf</small></div>
							</p>
						</li>
					</ul>
				</div>
			</div>
		</div>
		
			<div class="footer bg-dark text-light">
				
					<div class="container">
						<div class="row">
							<div class="col">
								&copy; Андрей Ламзин
							</div>
						</div>
					</div>
				
			</div>
		
        <script src="/j/jquery-3.3.1.slim.min.js"></script>
        <script src="/j/bootstrap4.2.1.min.js"></script>
        <script src="/j/popper1.14.6.min.js"></script>
        <script src="/j/prism/0.js"></script>
        <script src="/portfolio/vue2_editable_tree_view/compiled.js" charset="utf-8"></script>
        <link rel="stylesheet" type="text/css" href="/s/bootstrap4_sticky_footer.css">
	</body>
</html>
